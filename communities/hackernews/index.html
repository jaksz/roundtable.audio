<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="shortcut icon" href="icoicon.ico">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <title>Discourse.fm</title>
  <style>
      body{ 
          font-family: Verdana, Geneva, sans-serif;
          font-size: 13.33px;
      }
  </style>
      <script src="../../js/socket.io-client/dist/socket.io.js"></script>
      <script src="../../js/mobile-browser-check.js"></script>
      <script src="../../js/clipboard/dist/clipboard.min.js"></script>
      <script>
        $( document ).ready(function() {
            //var socket = io.connect("http://127.0.0.1:3000");
            var socket = io.connect("https://www.discourse.fm"); 
            //var socket = io.connect("/"); 

            // Add a connect listener
            socket.on('connect',function() {
               console.log('Client has connected to the server!');
            });
            
            var isIncompatibleBrowser = $.fn.isIncompatibleBrowser();
            
            if(isIncompatibleBrowser){
                $('#deviceBrowserAlertContainer').html('<div id="deviceBrowserAlert" class="alert alert-warning alert-dismissible fade show" role="alert" style="margin: 0px;"> <strong>Hold up!</strong> It looks like you may be using an incompatible device and browser. Discourse.fm will not work on iOS Chrome or iOS Firefox at the moment. For best results, we recommend using desktop Chrome. <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span></button></div>');
            }
            
            new ClipboardJS('#join-link-button');
            new ClipboardJS('#listen-link-button');
            
            function timeSince(date) {

              var seconds = Math.floor((new Date() - date) / 1000);

              var interval = seconds / 31536000;

              if (interval > 1) {
                return Math.floor(interval) + " years";
              }
              interval = seconds / 2592000;
              if (interval > 1) {
                return Math.floor(interval) + " months";
              }
              interval = seconds / 86400;
              if (interval > 1) {
                return Math.floor(interval) + " days";
              }
              interval = seconds / 3600;
              if (interval > 1) {
                return Math.floor(interval) + " hours";
              }
              interval = seconds / 60;
              if (interval > 1) {
                return Math.floor(interval) + " minutes";
              }
              return Math.floor(seconds) + " seconds";
            }
            
            let stories = [];
            
            $.fn.addStories = function(stories){
                console.log(stories);
                $('#stories').empty();
                for(var i = 0; i < 30; i++){
                    var story = stories[i];
                    if(story != null){
                        var author = story.by;
                        var time_since = timeSince(new Date(story.time * 1000));
                        var HN_url = 'https://news.ycombinator.com/item?id=' + story.id.toString();
                        if(story.url != null){
                            var story_url = story.url;
                            var domain_add = '<small style="color:grey"> (' + story.url.match(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n?]+)/img).toString().replace(/^(?:https?:\/\/)?(?:www\.)?/i, '') + ')</small>';
                        }else{
                            var story_url = HN_url;
                            var domain_add = '';
                        }
                        var el = '<div class="story" style=""><table><td style="vertical-align: top;"><span style="color:grey;">' + (i + 1).toString() +  '.</span></td><td><a href="' + story_url + '" style="text-decoration:none;color:black;"><span>' + story.title + '</span></a>' + domain_add + '<br><small style="color:grey;">' + story.score.toString() + ' points by <a href="#" style="color:grey;">' + story.by + '</a> ' + time_since + '</small><br><small>0 participants | 0 listeners | <a href="#" onclick="$.fn.joinOrCreateNewDiscourse(' + i + ')">Join Discourse</a></small></td></table></div>';
                        $('#stories').append(el);
                    }
                }
            }
            
            $.fn.getStories = function(type){
                var stories_url = "https://hacker-news.firebaseio.com/v0/" + type + "stories.json?print=pretty";
                $.get(stories_url, function(data, status){
                   for(var i = 0; i < 30; i++){
                       var story_url = "https://hacker-news.firebaseio.com/v0/item/" + data[i] + ".json?print=pretty";
                       const story_num = i;
                       $.get(story_url, function(story_data, story_status){
                           stories[story_num] = story_data;
                           if(stories.length == 30){
                               $.fn.addStories(stories);
                           }
                       });
                   }
                });
            }
            
            $.fn.getStories('top'); 
            
            $.fn.joinOrCreateNewDiscourse = function(story_num){
                var story = stories[story_num];
                var name = story.title;
                var HN_url = 'https://news.ycombinator.com/item?id=' + story.id.toString();
                discourse_info_array = {
                    "story_name": name,
                    "story_url": HN_url,
                    "community": "hackernews"
                }
                socket.emit('createCommunityDiscourseIfNotExist', discourse_info_array, function(err,data){
                    if(err == null){
                        var discourse_UDI = data;
                        window.location.href = 'https://www.hackernews.discourse.fm/live/' + discourse_UDI;
                    }else{
                        console.log(err);
                    }
                });
            }
            
        });
      </script>
  </head>
  <body>
    
    <div id="alerts" style="position:absolute;width:100%;">
    <div id="deviceBrowserAlertContainer"></div>
<!--    <div id="featureAlert"> <div id="featureAlert" class="alert alert-primary alert-dismissible fade show" role="alert" style="margin: 0px;"> <strong>New! </strong>Mention <a href="https://twitter.com/DiscourseFm" target="_blank">@DiscourseFm</a> anywhere on Twitter and include the words "start a discourse". We'll automatically reply with a link to a freshly-created discourse. <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span></button></div></div>-->
    </div>
      
    <nav class="navbar navbar-light" style="position:relative; background-color: #ff6600; float:none; display: inline-block; text-align: left; width: 100%;">
        <a href="https://news.ycombinator.com/" style="color:black;text-decoration: none; cursor:pointer">
            <span><b>Hacker News</b></span>  
        </a>
        <a href="https://discourse.fm" style="color:black;text-decoration: none; cursor:pointer">
            <span style="color:white;"><b>Discourse</b></span> |
        </a>
        <a href="#" style="color:black;" data-toggle="modal" data-target="#aboutModal" onclick="$.fn.getStories('top')">Top</a>
        <span style="">|</span> 
        <a href="#" style="color:black;" data-toggle="modal" data-target="#FAQModal" onclick="$.fn.getStories('new');">New</a>
        <span style="">|</span>
        <a href="#" style="color:black;" data-toggle="modal" data-target="#philosophyModal" onclick="$.fn.getStories('ask');">Ask</a>
        <span style="">|</span>
        <a href="#" style="color:black;" data-toggle="modal" data-target="#contactModal">Most Active</a>
<!--
        <span style="">|</span>
        <a href="#" style="color:black;" data-toggle="modal" data-target="#upcomingModal">About</a>
        <br>
-->  
    </nav>
      
    <div id="stories" style="position:relative; background-color: #f6f6f0; height: 100%; width:100%; padding: 15px;">
    
    </div> 
     
  </body>
</html>