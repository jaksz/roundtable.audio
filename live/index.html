<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="shortcut icon" href="../favicon.ico">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <title>Discourse.FM</title>
  <style>
    
  </style>
      <script src="../js/socket.io-client/dist/socket.io.js"></script>
      <script src="../js/browser-mobile-check.js"></script>
      <script src="../js/Base64.js"></script>
      <script src="../js/krakenclient.js"></script>
      <script src="../js/roundtable.js"></script>
      <script>
        $( document ).ready(function() {
            //var socket = io.connect("http://127.0.0.1:3000");
            var socket = io.connect("https://discourse.fm");
            //var socket = io.connect('/');
            
            // Add a connect listener
            socket.on('connect',function() {
               console.log('Client has connected to the server!');
            });
            
            var isMobile = $.fn.mobileAndTabletCheck();
            var isCompatibleBrowser = $.fn.browserCheck();
            
            if(isMobile == true || isCompatibleBrowser == false){
                window.alert('Hold up! It looks like you may be using an incompatible device or browser. For best results, we recommend using Discourse.fm on Chrome desktop for now.');
            }
            
            function uuidv4() {
               return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
               });
            } 
            
            function update_uname_history(UDI, uname){
                // maintain a persistent log of past uname's to prevent "phantom" users in a discourse
                var uname_history = localStorage.getItem(UDI + ':' + 'uname_history');
                var uname_history_array;
                if(!uname_history || uname_history == null){
                    uname_history_array = [];
                    uname_history_array.push(uname);
                    localStorage.setItem(UDI + ':' + 'uname_history', JSON.stringify(uname_history_array));
                }else{
                    uname_history_array = JSON.parse(uname_history);
                    if(uname_history_array.indexOf(uname) == -1){
                        uname_history_array.push(uname);
                        localStorage.setItem(UDI + ':' + 'uname_history', JSON.stringify(uname_history_array));
                    } 
                }
            }
            
            //get user id, or set if doesn't exist
            var user_id = localStorage.getItem('user_id');
            if (!user_id || user_id == "null" || user_id == null) { 
               user_id = uuidv4();
               localStorage.setItem('user_id', user_id);
            }
            
            var pathSplit = location.pathname.split('/');
            var UDI = pathSplit[pathSplit.length - 1];
            
            var nickname = localStorage.getItem(UDI+':'+user_id);
            if(nickname != null){
                var uname = user_id + ':' + Base64.encode(nickname);
                var unameRPC = encodeURIComponent(uname);
                update_uname_history(UDI, uname);
            }
            
            $.fn.copy_to_clipboard = function(text){
                var el = document.createElement('textarea');
                el.textContent = text;
                document.body.appendChild(el);
                
                var selection = document.getSelection();
                var range = document.createRange();
                
                range.selectNode(el);
                selection.removeAllRanges();
                selection.addRange(range);
                
                console.log('copy success', document.execCommand('copy'));
                selection.removeAllRanges();
                
                document.body.removeChild(el);
            }
            
            var UDI_link;
            var join_link;
            var listen_link;
            
            $.fn.copy_UDI_link = function(){
                $.fn.copy_to_clipboard(UDI_link);
                $('#copy-UDI-link-button').tooltip({title: 'Copied!'});
                $('#copy-UDI-link-button').tooltip('show');
                setTimeout(function(){
                    $('#copy-UDI-link-button').tooltip('dispose');
                }, 1000);
            }
            
            $.fn.copy_join_link = function(){
                $.fn.copy_to_clipboard(join_link);
                $('#copy-join-link-button').tooltip({title: 'Copied!'});
                $('#copy-join-link-button').tooltip('show');
                setTimeout(function(){
                    $('#copy-join-link-button').tooltip('dispose');
                }, 1000);
            }
            
            $.fn.copy_listen_link = function(){
                $.fn.copy_to_clipboard(listen_link);
                $('#copy-listen-link-button').tooltip({title: 'Copied!'});
                $('#copy-listen-link-button').tooltip('show');
                setTimeout(function(){
                    $('#copy-listen-link-button').tooltip('dispose');
                }, 1000);
            }
            
            
            $.fn.setNickName = function(){
                    nickname = $('#nickname-input').val(); 
                    if (!nickname || nickname.trim() === '') {
                        $('#nickname-input').addClass('is-invalid');
                        $('#nickname-input').tooltip({title: 'Nickname cannot be empty.'});
                        $('#nickname-input').tooltip('show');
                        setTimeout(function(){
                            $('#nickname-input').tooltip('dispose');
                        }, 3000);
                    } else if (nickname.length > 32) {
                        $('#nickname-input').addClass('is-invalid');
                        $('#nickname-input').tooltip({title: 'Nickname cannot be more than 32 characters.'});
                        $('#nickname-input').tooltip('show');
                        setTimeout(function(){
                            $('#nickname-input').tooltip('dispose');
                        }, 3000);
                    } else {
                        $('#nickname-input').addClass('is-valid');
                        localStorage.setItem(UDI+':'+user_id, nickname);
                        uname = user_id + ':' + Base64.encode(nickname);
                        unameRPC = encodeURIComponent(uname);
                        update_uname_history(UDI, uname);
                        $('#nickNameModal').modal('hide');
                        $.fn.joinDiscourse();
                    }
            }
            
            var JID = null;
            var LID = null;
            var JID_secret = null;
            var LID_secret = null;
            
            // get data 
            var local_discourse_data = localStorage.getItem(UDI);
            console.log(local_discourse_data);
            local_discourse_data = JSON.parse(local_discourse_data);
            
            if(local_discourse_data != null){
                JID = local_discourse_data['JID'];
                JID_secret = local_discourse_data['JID_secret'];
                LID = local_discourse_data['LID'];
                LID_secret = local_discourse_data['LID_secret'];
            }
            
            var auth_into_discourse_array = {
                "UDI": UDI,
                "JID": JID,
                "LID": LID,
                "JID_secret": JID_secret,
                "LID_secret": LID_secret
            }
            
            var current_listeners = 0;
            var current_participants = 0;
            socket.emit('auth_into_discourse', auth_into_discourse_array, function(err,data){
                if(err != 'error'){
                    if(data != null){
                        if(data['end_datetime'] != null){
                            //add proper handler if discourse has ended 
                            $.fn.populateDiscourseContent(data, 'ended');
                        }else{
                            console.log(data);
                            if(data['join_auth'] == false && data['listen_auth'] == false){
                                //tell user to revisit the join/listen links and then redirect them to the home page (probably a hacker, but let's not accuse them) 
                                window.alert('You are not authorized to join or listen to this discourse. Make sure local storage is not disabled and revisit the join or listen link for this discourse to try again.');
                                window.location.href = window.location.href.split("/live")[0];
                            }else if(data['join_auth'] == false && data['listen_auth'] == true){
                                // send request to begin listening via LID secret (server will allow regardless if LID secret is not necessary)
                                $.fn.listenToDiscourse();
                                $.fn.populateShareLinks(data, 'listen');
                                $.fn.populateDiscourseContent(data, 'listen');
                            }else if(data['join_auth'] == true && data['listen_auth'] == false){
                                // this case should not really appear, but if so
                                //tell user to revisit the join/listen links and then redirect them to the home page (probably a hacker, but let's not accuse them)
                                window.alert('You are not authorized to listen to this discourse. Make sure local storage is not disabled and revisit the join or listen link for this discourse to try again.');
                                window.location.href = window.location.href.split("/live")[0];
                            }else if(data['join_auth'] == true && data['listen_auth'] == true){
                                // send request to begin listening via LID secret (server will allow regardless if LID secret is not necessary)
                                // send request to join discourse via JID secret (server will allow regardless if LID secret is not necessary)
                                $.fn.listenToDiscourse();
                                $.fn.populateShareLinks(data, 'join');
                                $.fn.populateDiscourseContent(data, 'join');
                            }
                        }
                    }else{
                        // add proper handler for non-available discourse or UDI collision
                        window.alert('The requested discourse is not available.');
                        window.location.href = window.location.href.split("/live")[0];
                    }
                }else{
                    // add proper handler for error 
                    window.alert('Whoops! Something went wrong on our end. Please try again.');
                    window.location.href = window.location.href.split("/live")[0];
                }
            });
            
            $.fn.populateDiscourseContent = function(data, status){
                $('#discourse-name').html(data['name']);
                $('#discourse-description').html(data['description']);
                var tag_string = '';
                for(var i = 0; i < data['tags'].length; i++){
                    tag_string += '#' + data['tags'][i] + ' ';
                }
                $('#discourse-tags').html(tag_string);
                $('#discourse-start-time').html(data['start_datetime']);
                $('#discourse-participants').html(data['current_participants']);
                $('#discourse-listeners').html(data['current_listeners']);
                $.fn.updateListeners(data['current_listeners']);
                
                if(status == 'ended'){
                    $('discourse-end-time').html(' | Ended at: ' + data['end_datetime']);
                }
                if(status == 'join'){
                    var join_button = document.createElement('button');
                    join_button.id = 'join-button'
                    join_button.type = 'button';
                    join_button.className = 'btn btn-success';
                    join_button.onclick = function(){ $.fn.joinDiscourse(); }; 
                    join_button.innerHTML = 'Join Discourse <img src="../icons/arrow-up-circle-white.svg" />';
                    document.getElementById('discourse-actions').appendChild(join_button);
                }
//                    var listen_button = document.createElement('button');
//                    listen_button.type = 'button';
//                    listen_button.className = 'btn btn-primary mr-1';
//                    listen_button.onclick = function(){ $.fn.listenToDiscourse() }; 
//                    listen_button.innerHTML = 'Listen to Discourse';
//                    document.getElementById('discourse-actions').appendChild(listen_button);
                
            }
            
            $.fn.populateShareLinks = function(data, status){
                var public_listen = data['public_listen'];
                var public_join = data['public_join'];
                var show_URL = false;
                var show_listen = false;
                var show_join = false;
                if(public_join == false && public_listen == false){
                    if(status == 'join'){
                        $('#discourseShareStatus').html("This discourse is private join/private listen. Send one of the links below to allow others to listen or participate.");
                        show_listen = true;
                        show_join = true;
                    }else if(status == 'listen'){
                        $('#discourseShareStatus').html("This discourse is private join/private listen. Send the link below to allow others to listen.");
                        show_listen = true;
                    }
                }else if(public_join == false && public_listen == true){
                    if(status == 'join'){
                        $('#discourseShareStatus').html("This discourse is private join/public listen. Send the discourse URL to allow others to listen or the join link to allow others to participate.");
                        show_URL = true;
                        show_join = true;
                    }else if(status == 'listen'){
                        $('#discourseShareStatus').html("This discourse is private join/public listen. Send the discourse URL to allow others to listen.");
                        show_URL = true;
                    }
                }else if(public_join == true && public_listen == true){
                    $('#discourseShareStatus').html("This discourse is public join/public listen. Send the discourse URL to allow others to listen or participate.");
                    show_URL = true;
                }
                
                if(show_URL){
                    UDI_link = 'https://www.discourse.fm/live/' + UDI;
                    $('#UDI-link-label').html(UDI_link);
                    $('#UDI-link').css('display', 'block');
                }
                if(show_listen){
                    listen_link = 'https://www.discourse.fm/?lid=' + LID;
                    $('#listen-link-label').html(listen_link);
                    $('#listen-link').css('display', 'block');
                }
                if(show_join){
                    join_link = 'https://www.discourse.fm/?jid=' + JID;
                    $('#join-link-label').html(join_link);
                    $('#join-link').css('display', 'block');
                }
            }
            
            $.fn.leaveDiscourse = function(){
                $.fn.listenToDiscourse();
                $.fn.removeSeat(user_id);
                $('#micicon').css('display', 'none');
                $('#micicon').attr("src", '../icons/mic.svg');
                $('#micicon').data('muted', "unmuted");
            }
            
            $.fn.toggleUserMute = function(){
                toggle_user_muted();
                if($('#micicon').data('muted') == "unmuted"){
                    $('#micicon').attr("src", '../icons/mic-mute.svg');
                    $('#micicon').data('muted', "muted");
                }else{
                    $('#micicon').attr("src", '../icons/mic.svg');
                    $('#micicon').data('muted', "unmuted");
                }
            }
            
            $.fn.toggleJoinButton = function(){
                if($('#join-button').hasClass('btn-success')){
                    $('#join-button').removeClass('btn-success');
                    $('#join-button').addClass('btn-danger');
                    $('#join-button').html('Leave Discourse <img src="../icons/arrow-down-circle-white.svg" />');
                    $('#join-button').attr('onclick', '$.fn.leaveDiscourse()');
                }else{
                    $('#join-button').removeClass('btn-danger');
                    $('#join-button').addClass('btn-success');
                    $('#join-button').html('Join Discourse <img src="../icons/arrow-up-circle-white.svg" />');
                    $('#join-button').attr('onclick', '$.fn.joinDiscourse()');
                }
            }
            
            $.fn.joinDiscourse = function(){
                var nickname = localStorage.getItem(UDI+':'+user_id);
                if (!nickname || nickname === '') {
                   $('#nickNameModal').modal('show');
                }else{
                     start_client('participant', UDI, unameRPC, user_id, socket);
                     publish_client(UDI, unameRPC, user_id, socket);
                     $.fn.addSeat(nickname, user_id, true);
                     var connection_data = {
                         "UDI": UDI,
                         "user_id": user_id,
                         "connection_type": "join"
                     }
                     socket.emit('connectToDiscourse', connection_data, function(err, data){
//                         if(err == null){
//                             $.fn.updateListeners(data['current_listeners']);
//                         }
                     });
                     $.fn.toggleJoinButton();
                     $('#micicon').css('display', 'block');
                }
            }
            
            $.fn.listenToDiscourse = function(){
                    toggle_user_muted();
                    stop_user_stream();
                    start_client('listen_only', UDI, '', '', socket);
                    register_listen_only_peer_client(UDI, socket); 
                    var connection_data = {
                         "UDI": UDI,
                         "user_id": user_id,
                         "connection_type": "listen"
                     }
                     socket.emit('connectToDiscourse', connection_data, function(err, data){
//                         if(err == null){
//                             $.fn.updateListeners(data['current_listeners']);
//                         }
                     });
                    $.fn.toggleJoinButton();
            }
            
            socket.on('updateDiscourseCount', function(count_data, handler){
                console.log(count_data);
                if(count_data['type'] == 'values'){
                    current_listeners = parseInt(count_data['current_listeners']);
                    current_participants = parseInt(count_data['current_participants']);
                }else if(count_data['type'] == 'add_participant'){
                    current_participants += 1;
                }else if(count_data['type'] == 'add_listener'){ 
                    current_listeners += 1;
                }else if(count_data['type'] == 'subtract_participant'){
                    current_participants -= 1;
                }else if(count_data['type'] == 'subtract_listener'){
                    current_listeners -= 1;
                }
                $.fn.updateListeners(current_listeners);
            });
            
            socket.on('removeSeat', function(remove_seat_data, handler){
                var id_to_remove = remove_seat_data['user_id'];
                $.fn.removeSeat(id_to_remove);
            });
            
        });
            
      </script>
  </head>
  <body>
      
    <a href="../" style="position:absolute;top:5px;left:5px;">
        <img src="../icons/house.svg" style="height:35px;width:auto;"/>  
    </a>
      
    <a href="../" style="position:absolute;top:5px;right:5px;" data-toggle="modal" data-target="#shareModal">
        <img src="../icons/share.svg" style="height:35px;width:auto;"/>  
    </a>
      
    <img src="../icons/mic.svg" id="micicon" style="height:35px;width:auto;position:absolute;bottom:5px;right:5px;display:none;cursor:pointer;" onclick="$.fn.toggleUserMute()" data-muted="unmuted"/>  
      
    <div class="modal fade" id="nickNameModal" tabindex="-1" aria-labelledby="nickNameModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nickNameModalLabel">Enter a nickname to join!</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="nickname-input" class="col-form-label">Enter a name:</label>
                <input type="text" class="form-control" id="nickname-input" placeholder="Ex. McLovin">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="$.fn.setNickName()" id="enter-discourse">Enter Discourse</button>
          </div>
        </div>
      </div>
    </div>
      
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
           <div class="modal-body">
               <h4 id="discourseShareStatus"></h4>
                <label id="UDI-link" style="display: none;">Link to Discourse: <br><div class="container" style="background-color:rgba(0,0,0,0.025);"><span class="private-links mr-3" id="UDI-link-label" style="font-size:10.5px;"></span><button type="button" id="copy-UDI-link-button" class="btn btn-sm" onclick="$.fn.copy_UDI_link()"><img src="../icons/clipboard-plus.svg" alt="" width="15" height="15" title="Bootstrap"></button></div></label>
                <label id="join-link" style="display: none;">Join Link: <br><div class="container" style="background-color:rgba(0,0,0,0.025);"><span class="private-links mr-3" id="join-link-label" style="font-size:10.5px;"></span><button type="button" id="copy-join-link-button" class="btn btn-sm" onclick="$.fn.copy_join_link()"><img src="../icons/clipboard-plus.svg" alt="" width="15" height="15" title="Bootstrap"></button></div></label>
                <label id="listen-link" style="display: none;">Listen Link: <br><div class="container" style="background-color:rgba(0,0,0,0.025);"><span class="private-links mr-3" id="listen-link-label" style="font-size:10.5px;"></span><button type="button" id="copy-listen-link-button" class="btn btn-sm" onclick="$.fn.copy_listen_link()"><img src="../icons/clipboard-plus.svg" alt="" width="15" height="15" title="Bootstrap"></button></div></label>
           </div>
        </div>
      </div> 
    </div>  
    
    <div class="container min-vh-100">
      <div class="row min-vh-100 justify-content-center align-items-center">
        <div class="column col-md-12 text-center"> <!-- class="text-center" -->
            <h1 class="display-3" id="discourse-name"></h1> 
            <h3 id="discourse-description"></h3>
            <h4 id="discourse-tags"></h4>
            <div id="peers"></div>
            <canvas id="roundtable"></canvas>
            <div id="discourse-actions"></div>
            <br>
        </div>
      </div>
    </div>
  </body>
</html>