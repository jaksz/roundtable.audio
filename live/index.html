<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <title>Discourse.FM</title>
  <style>
    
  </style>
      <script src="../node_modules/socket.io-client/dist/socket.io.js"></script>
      <script src="../Base64.js"></script>
      <!--<script src="../krakenapi.js"></script>-->
      <script src="../krakenclient.js"></script>
      <script src="../roundtable.js"></script>
      <script>
        $( document ).ready(function() {
            //var socket = io("http://127.0.0.1:3000");
            var socket = io.connect("https://discourse.fm");
            // Add a connect listener
            socket.on('connect',function() {
               console.log('Client has connected to the server!');
            });
            
            function uuidv4() {
               return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
               });
            }
            
            //get user id, or set if doesn't exist
            var user_id = localStorage.getItem('user_id');
            if (!user_id || user_id == "null" || user_id == null) { 
               user_id = uuidv4();
               localStorage.setItem('user_id', user_id);
            }
            
            var pathSplit = location.pathname.split('/')
            var UDI = pathSplit[pathSplit.length - 1];
            
            
            var nickname = localStorage.getItem(UDI+':'+user_id);
            if(nickname != null){
                var uname = user_id + ':' + Base64.encode(nickname);
                var unameRPC = encodeURIComponent(uname);
            }
            
            $.fn.setNickName = function(){
                    nickname = $('#nickname-input').val(); 
                    if (!nickname || nickname.trim() === '') {
                        $('#nickname-input').addClass('is-invalid');
                        $('#nickname-input').tooltip({title: 'Nickname cannot be empty.'});
                        $('#nickname-input').tooltip('show');
                        setTimeout(function(){
                            $('#nickname-input').tooltip('dispose');
                        }, 3000);
                    } else if (nickname.length > 32) {
                        $('#nickname-input').addClass('is-invalid');
                        $('#nickname-input').tooltip({title: 'Nickname cannot be more than 32 characters.'});
                        $('#nickname-input').tooltip('show');
                        setTimeout(function(){
                            $('#nickname-input').tooltip('dispose');
                        }, 3000);
                    } else {
                        $('#nickname-input').addClass('is-valid');
                        localStorage.setItem(UDI+':'+user_id, nickname);
                        uname = user_id + ':' + Base64.encode(nickname);
                        unameRPC = encodeURIComponent(uname);
                        $('#nickNameModal').modal('hide');
                        $.fn.joinDiscourse();
                    }
            }
            
            var JID = null;
            var LID = null;
            var JID_secret = null;
            var LID_secret = null;
            
            // get data 
            var local_discourse_data = localStorage.getItem(UDI);
            local_discourse_data = JSON.parse(local_discourse_data);
            
            if(local_discourse_data != null){
                JID = local_discourse_data['JID'];
                JID_secret = local_discourse_data['JID_secret'];
                LID = local_discourse_data['LID'];
                LID_secret = local_discourse_data['LID_secret'];
            }
            
            var auth_into_discourse_array = {
                "UDI": UDI,
                "JID": JID,
                "LID": LID,
                "JID_secret": JID_secret,
                "LID_secret": LID_secret
            }
                
            socket.emit('auth_into_discourse', auth_into_discourse_array, function(err,data){
                if(err != 'error'){
                    if(data != null){
                        if(data['end_datetime'] != null){
                            //add proper handler if discourse has ended 
                            $.fn.populateDiscourseContent(data, 'ended');
                        }else{
                            if(data['join_auth'] == false && data['listen_auth'] == false){
                                //tell user to revisit the join/listen links and then redirect them to the home page (probably a hacker, but let's not accuse them) 
                                window.alert('You are not authorized to join or listen to this discourse. Make sure local storage is not disabled and revisit the join or listen link for this discourse to try again.');
                                window.location.href = window.location.href.split("/live")[0];
                            }else if(data['join_auth'] == false && data['listen_auth'] == true){
                                // send request to begin listening via LID secret (server will allow regardless if LID secret is not necessary)
                                $.fn.populateDiscourseContent(data, 'listen');
                            }else if(data['join_auth'] == true && data['listen_auth'] == false){
                                // this case should not really appear, but if so
                                //tell user to revisit the join/listen links and then redirect them to the home page (probably a hacker, but let's not accuse them)
                                window.alert('You are not authorized to listen to this discourse. Make sure local storage is not disabled and revisit the join or listen link for this discourse to try again.');
                                window.location.href = window.location.href.split("/live")[0];
                            }else if(data['join_auth'] == true && data['listen_auth'] == true){
                                // send request to begin listening via LID secret (server will allow regardless if LID secret is not necessary)
                                // send request to join discourse via JID secret (server will allow regardless if LID secret is not necessary)
                                $.fn.populateDiscourseContent(data, 'join');
                            }
                        }
                    }else{
                        // add proper handler for non-available discourse or UDI collision
                        $('The requested discourse is not available.');
                        window.location.href = window.location.href.split("/live")[0];
                    }
                }else{
                    // add proper handler for error 
                    $('Whoops! Something went wrong on our end. Please try again.');
                    window.location.href = window.location.href.split("/live")[0];
                }
            });
            
            $.fn.populateDiscourseContent = function(data, status){
                $('#discourse-name').html(data['name']);
                $('#discourse-description').html(data['description']);
                var tag_string = '';
                for(var i = 0; i < data['tags'].length; i++){
                    tag_string += '#' + data['tags'][i] + ' ';
                }
                $('#discourse-tags').html(tag_string);
                $('#discourse-start-time').html(data['start_datetime']);
                $('#discourse-participants').html(data['current_participants']);
                $('#discourse-listeners').html(data['current_listeners']);
                
                // user would have been redirected if not at least allowed to listen
                if(status != 'ended'){
                    $('discourse-end-time').html(' | Ended at: ' + data['end_datetime']);
                }{
                    var listen_button = document.createElement('button');
                    listen_button.type = 'button';
                    listen_button.className = 'btn btn-primary mr-1';
                    listen_button.onclick = function(){ $.fn.listenToDiscourse() }; 
                    listen_button.innerHTML = 'Listen to Discourse';
                    document.getElementById('discourse-actions').appendChild(listen_button);

                    if(status == 'join'){
                        var join_button = document.createElement('button');
                        join_button.type = 'button';
                        join_button.className = 'btn btn-success';
                        join_button.onclick = function(){ $.fn.joinDiscourse() }; 
                        join_button.innerHTML = 'Join Discourse';
                        document.getElementById('discourse-actions').appendChild(join_button);
                    }
                }
            }
            
            $.fn.joinDiscourse = function(){
                var nickname = localStorage.getItem(UDI+':'+user_id);
                if (!nickname || nickname === '') {
                   $('#nickNameModal').modal('show');
                }else{
                     start_client('participant', UDI, unameRPC, user_id, socket);
                     publish_client(UDI, unameRPC, user_id, socket);
                     $.fn.addSeat(nickname, user_id, true);
                }
            }
            
            $.fn.listenToDiscourse = function(){
                    start_client('listen_only', UDI, '', '', socket);
                    register_listen_only_peer_client(UDI, socket); 
            }
            
        });
            
      </script>
  </head>
  <body> 
      
    <div class="modal fade" id="nickNameModal" tabindex="-1" aria-labelledby="nickNameModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nickNameModalLabel">Enter a nickname to join!</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="nickname-input" class="col-form-label">Enter a name:</label>
                <input type="text" class="form-control" id="nickname-input" placeholder="Ex. McLovin">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="$.fn.setNickName()" id="enter-discourse">Enter Discourse</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container min-vh-100">
      <div class="row min-vh-100 justify-content-center align-items-center">
        <div class="column col-md-12 text-center"> <!-- class="text-center" -->
            <h1 class="display-3" id="discourse-name">Discourse Name</h1> 
            <h3 id="discourse-description">Description</h3>
            <h4 id="discourse-tags">Tags</h4>
            <div id="peers"></div>
<!--
            <h5>Began at: <span id="discourse-start-time"></span> <span id="discourse-end-time"></span></h5>
            <h5><span id="discourse-participants"></span> Participants | <span id="discourse-listeners"> </span> Listeners</h5>
-->
            <canvas id="roundtable"></canvas>
            <div id="discourse-actions"></div>
            <br>
        </div>
      </div>
    </div>
  </body>
</html>